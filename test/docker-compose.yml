version: '3'

services:
  redis:
    image: redis:latest
    ports:
      - "6379:6379"

  nitter-redis:
    image: redis:latest

  nitter:
    image: kristobalus/nitter:1.0.0
    platform: "linux/amd64"
    entrypoint: |
      /bin/sh -c '
        cp /config/nitter.conf /src/nitter.conf
        cp /config/guest_accounts.json /src/guest_accounts.json
        ./nitter
      '
    ports:
      - "8080:8080"
    depends_on:
      - nitter-redis
    volumes:
      - ./configs/nitter:/config

  ms-users:
    depends_on:
      - redis-cluster
      - rabbitmq
    image: makeomatic/ms-users:15.11.1
    hostname: ms-users
    volumes:
      - ${PWD}/test/configs:/src/configs:ro
    environment:
      NCONF_FILE_PATH: '["/src/configs/ms-users/config.js"]'
      MS_USERS__LOGGER__DEFAULT_LOGGER: 'true'
      MS_USERS__INIT_ADMIN_ACCOUNTS_DELAY: '1'

  tester:
    depends_on:
      - postgres
      - rabbitmq
    env_file:
      - ${PWD}/.env
    environment:
      NODE_ENV: "test"
      DEBUG: ${DEBUG}
      NCONF_NAMESPACE: MS_SOCIAL
