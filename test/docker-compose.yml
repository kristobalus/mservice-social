version: '3'

services:
  redis:
    image: redis:latest
    ports:
      - "6379:6379"

  nitter-redis:
    image: redis:latest

  nitter:
    image: kristobalus/nitter:latest
    platform: "linux/amd64"
    environment:
      NITTER_GUEST_ACCOUNTS_URL: "${NITTER_GUEST_ACCOUNTS_URL}"
    entrypoint: |
      /bin/sh -c '
        echo $NITTER_GUEST_ACCOUNTS_URL
        cp /config/nitter.conf /src/nitter.conf
        wget -O /src/guest_accounts.json $NITTER_GUEST_ACCOUNTS_URL
        ./nitter
      '
    ports:
      - "8080:8080"
    depends_on:
      - nitter-redis
    volumes:
      - ${PWD}/test/configs/nitter:/config:ro

  ms-users:
    platform: linux/amd64
    depends_on:
      - redis-cluster
      - rabbitmq
    image: makeomatic/ms-users:16.3.0
    hostname: ms-users
    volumes:
      - ${PWD}/test/configs:/src/configs:ro
    environment:
      NCONF_FILE_PATH: '["/src/configs/ms-users/config.js"]'
      MS_USERS__LOGGER__DEFAULT_LOGGER: 'true'
      MS_USERS__INIT_ADMIN_ACCOUNTS_DELAY: '1'

  tester:
    depends_on:
      - postgres
      - rabbitmq
      - nitter
    env_file:
      - ${PWD}/.env
    environment:
      NODE_ENV: "test"
      NITTER_URL: 'http://nitter:8080'
      DEBUG: ${DEBUG}
      NCONF_NAMESPACE: MS_SOCIAL
